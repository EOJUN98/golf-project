# TUGOL Project Context & Codebase Snapshot (v1.0)
**Date:** 2026-01-15
**Version:** MVP v1.0 (Integration Complete)
**Tech Stack:** Next.js 16 (App Router), TypeScript, Supabase, Tailwind CSS

---

## 1. Database Schema & Architecture
**File:** `SUPABASE-USER-MIGRATION.sql`
**Status:** Applied (UUID Migration Complete)

```sql
-- 1. Enable UUID extension
create extension if not exists "uuid-ossp";

-- 2. Golf Clubs Table
CREATE TABLE golf_clubs (
  id BIGSERIAL PRIMARY KEY,
  name TEXT NOT NULL,
  location_name TEXT NOT NULL,
  location_lat DECIMAL(10, 8) NOT NULL,
  location_lng DECIMAL(11, 8) NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 3. Users Table (Linked to Supabase Auth)
CREATE TABLE users (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  email TEXT NOT NULL,
  name TEXT,
  phone TEXT,
  segment TEXT NOT NULL DEFAULT 'FUTURE' CHECK (segment IN ('FUTURE', 'PRESTIGE', 'SMART', 'CHERRY')),
  cherry_score INTEGER DEFAULT 0,
  terms_agreed_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 4. Tee Times Table (Core Product)
CREATE TABLE tee_times (
  id BIGSERIAL PRIMARY KEY,
  golf_club_id BIGINT REFERENCES golf_clubs(id) ON DELETE CASCADE,
  tee_off TIMESTAMP WITH TIME ZONE NOT NULL,
  base_price INTEGER NOT NULL,
  status TEXT NOT NULL DEFAULT 'OPEN' CHECK (status IN ('OPEN', 'BOOKED', 'BLOCKED')),
  weather_condition JSONB, -- Stores {sky, temperature, rainProb, windSpeed}
  reserved_by UUID REFERENCES users(id) ON DELETE SET NULL,
  reserved_at TIMESTAMP WITH TIME ZONE
);

-- 5. Reservations Table (Transactions)
CREATE TABLE reservations (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  tee_time_id BIGINT NOT NULL REFERENCES tee_times(id),
  user_id UUID NOT NULL REFERENCES users(id),
  base_price INTEGER NOT NULL,
  final_price INTEGER NOT NULL,
  discount_breakdown JSONB, -- Stores logic trace
  payment_key TEXT,
  payment_status TEXT DEFAULT 'PENDING' CHECK (payment_status IN ('PENDING', 'PAID', 'CANCELLED', 'REFUNDED')),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

---

## 2. Type Definitions
**File:** `types/database.ts`
**Role:** TypeScript interfaces mirroring the DB.

```typescript
export interface Database {
  public: {
    Tables: {
      users: {
        Row: {
          id: string // UUID
          email: string
          name: string | null
          phone: string | null
          segment: 'FUTURE' | 'PRESTIGE' | 'SMART' | 'CHERRY'
          cherry_score: number
          terms_agreed_at: string | null
          created_at: string
          updated_at: string | null
        }
      },
      tee_times: {
        Row: {
          id: number
          golf_club_id: number
          tee_off: string
          base_price: number
          status: 'OPEN' | 'BOOKED' | 'BLOCKED'
          weather_condition: Json | null
          reserved_by: string | null // UUID
          reserved_at: string | null
        }
      },
      // ... (reservations and golf_clubs omitted for brevity, same as SQL)
    }
  }
}
```

---

## 3. Core Logic: Pricing Engine
**File:** `utils/pricingEngine.ts`
**Role:** Deterministic algorithm for dynamic pricing.

```typescript
export interface PricingContext {
  teeTime: TeeTime;
  user?: User;
  weather?: Weather;
  userDistanceKm?: number;
  now?: Date;
}

export function calculatePricing(ctx: PricingContext): PricingResult {
  const { teeTime, user, weather, userDistanceKm } = ctx;
  const now = ctx.now || new Date();
  const teeOff = new Date(teeTime.tee_off);
  const basePrice = teeTime.base_price;
  
  let currentPrice = basePrice;

  // 1. Weather Blocking (Safety)
  if (weather && weather.rn1 >= 10) {
    return { isBlocked: true, blockReason: 'WEATHER_STORM', ... };
  }

  // 2. Step-Down Discount (Time-based)
  // Logic: 2 hours before tee-off, prices drop in 3 random-interval steps.
  // Step Amount: 10,000 KRW (if >= 100k) or 5,000 KRW (if < 100k)
  const rng = new SeededRandom(teeTime.id); // Deterministic randomness
  // ... (Calculation logic omitted)

  // 3. Multiplicative Discounts
  // - Rain/Cloudy: 10~20%
  // - VIP (PRESTIGE): 5%
  // - LBS (Nearby): 10%
  
  // 4. Governance
  // Max Discount Cap: 40%
  // Floor Price protection
  
  return { finalPrice, basePrice, discountRate, ... };
}
```

---

## 4. Backend: Data Access & Logic Integration
**File:** `utils/supabase/queries.ts`
**Role:** Server Actions bridging DB and Pricing Engine.

```typescript
export async function getTeeTimesByDate(date: Date, userSegment: UserSegment = 'FUTURE'): Promise<TeeTimeWithPricing[]> {
  // 1. Fetch from DB
  const { data: teeTimes } = await supabase
    .from('tee_times')
    .select('*')
    .gte('tee_off', startISO)
    .lte('tee_off', endISO);

  // 2. Apply Pricing Engine per item
  return teeTimes.map((item: any) => {
    // Parse Weather from DB JSONB
    let weatherData: WeatherData;
    if (item.weather_condition) {
        weatherData = { ...item.weather_condition };
    } else {
        weatherData = generateMockWeather(...); // Fallback
    }

    const ctx: PricingContext = {
      teeOff: new Date(item.tee_off),
      basePriceInput: item.base_price,
      weather: weatherData,
      segment: userSegment, // Real User Segment
    };

    const result = calculateDynamicPrice(ctx);

    return {
      id: item.id,
      finalPrice: result.finalPrice,
      basePrice: result.basePrice,
      // ...
    };
  });
}
```

---

## 5. Admin System: Control Tower
**File:** `components/AdminDashboard.tsx`
**Role:** Operational dashboard for Revenue, Price Override, and Weather Sim.

**Key Features:**
1.  **Sales Chart:** Visualizes daily revenue using CSS bar charts.
2.  **Price Override:** `updateBasePrice` function allows manual modification of `base_price`.
3.  **Weather Simulation:** Trigger button for `/api/admin/simulate-weather`.

```typescript
// Price Override Logic
const updateBasePrice = async (id: number, currentPrice: number) => {
    const newPriceStr = window.prompt('새로운 기준 가격을 입력하세요 (원):', currentPrice.toString());
    // ... validation ...
    await supabase.from('tee_times').update({ base_price: newPrice }).eq('id', id);
};

// Weather Sim Trigger
<button onClick={async () => {
    await fetch('/api/admin/simulate-weather', { method: 'POST' });
    window.location.reload();
}}>
    Weather Sim
</button>
```

**File:** `app/api/admin/simulate-weather/route.ts`
**Role:** Simulation tool to randomize weather conditions in DB.

```typescript
export async function POST() {
    const { data: teeTimes } = await supabase.from('tee_times').select('id').eq('status', 'OPEN');
    
    for (const t of teeTimes || []) {
      const weather = generateRandomWeather(); // Randomly assigns RAIN, CLOUDY, CLEAR
      await supabase.from('tee_times').update({ weather_condition: weather }).eq('id', t.id);
    }
    return NextResponse.json({ message: 'Weather simulation completed' });
}
```

---

## 6. Frontend: User Experience
**File:** `components/TeeTimeList.tsx`
**Role:** Main booking interface. Handles "Panic Mode" and displays pricing.

**Key Features:**
- **Panic Mode:** 59-minute countdown timer overlay for imminent tee times.
- **User Segment:** Passes `userId` (UUID) to `BookingModal`.
- **Filtering:** 3-part time slot filtering (Morning, Day, Night).

**File:** `components/BookingModal.tsx`
**Role:** Payment processing integration.

**Key Features:**
- **Toss Payments:** Integrated via `@tosspayments/payment-widget-sdk`.
- **UUID Support:** Accepts `userId` as string (UUID).
- **Pricing Display:** Shows Base Price -> Discounts -> Final Price breakdown.

---

## 7. Auth & Legal
**File:** `app/login/page.tsx`
- Kakao OAuth Login button.
- Explicit disclaimer links to Terms & Privacy Policy.

**File:** `app/policy/terms/page.tsx` & `app/policy/privacy/page.tsx`
- Static content pages for legal compliance.
