require('dotenv').config({ path: '.env.local' });

const express = require('express');
const app = express();
const port = 3000;

// ==========================================
// 1. ì„¤ì • ë° API í‚¤ (í™˜ê²½ë³€ìˆ˜ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°)
// ==========================================
const SERVICE_KEY = process.env.WEATHER_API_KEY;

const CLUB_NAME = process.env.CLUB_NAME || "Club 72";
const BASE_PRICE = parseInt(process.env.BASE_PRICE) || 250000;
const GRID_X = parseInt(process.env.GRID_X) || 54; // ê³¨í”„ì¥ ìœ„ì¹˜ (ì¸ì²œ)
const GRID_Y = parseInt(process.env.GRID_Y) || 123;

// [NEW] ì‚¬ìš©ì ë°ì´í„° (ìœ„ì¹˜ ì •ë³´ & í™œë™ ì´ë ¥ ì¶”ê°€)
const userProfile = {
    name: "ì´íšŒì¥",
    grade: "VIP",
    // 1. ìœ„ì¹˜ ì •ë³´ (í˜„ì¬ ì‚¬ìš©ìê°€ ì¸ì²œì— ìˆë‹¤ê³  ê°€ì •)
    currentLocation: { x: 54, y: 123 }, 
    // 2. í™œë™ ì´ë ¥ (ì¶©ì„±ë„ íŒë‹¨ ê¸°ì¤€)
    visitCount: 25,       // ìµœê·¼ ì ‘ì† íšŸìˆ˜ (ë§ìŒ)
    avgStayTime: 45,      // í‰ê·  ì²´ë¥˜ ì‹œê°„ (45ë¶„ - ì•„ì£¼ ê¹€)
};

// ê¸°ìƒì²­ API í•¨ìˆ˜
async function getWeatherForecast() {
    const now = new Date();
    const timeBlocks = [2, 5, 8, 11, 14, 17, 20, 23];
    let baseHour = 23;
    let baseDateStr = "";
    
    let hour = now.getHours();
    const safeHour = hour - 1;
    for (let t of timeBlocks) if (t <= safeHour) baseHour = t;

    if (hour < 2) {
        const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);
        baseDateStr = `${yesterday.getFullYear()}${('0' + (yesterday.getMonth() + 1)).slice(-2)}${('0' + yesterday.getDate()).slice(-2)}`;
        baseHour = 23;
    } else {
        baseDateStr = `${now.getFullYear()}${('0' + (now.getMonth() + 1)).slice(-2)}${('0' + now.getDate()).slice(-2)}`;
    }
    const baseTimeStr = ('0' + baseHour).slice(-2) + "00";

    const url = `http://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getVilageFcst`;
    const queryParams = '?' + new URLSearchParams({
        serviceKey: SERVICE_KEY, pageNo: '1', numOfRows: '30', dataType: 'JSON',
        base_date: baseDateStr, base_time: baseTimeStr, nx: GRID_X, ny: GRID_Y
    }).toString();

    try {
        const response = await fetch(url + queryParams);
        const json = await response.json();
        if (json.response.header.resultCode === '00') {
            const items = json.response.body.items.item;
            const popItem = items.find(item => item.category === 'POP');
            return popItem ? parseInt(popItem.fcstValue) : 0;
        }
        return 0;
    } catch (error) { return 0; }
}

// ==========================================
// 2. ë¼ìš°í„° (ê°€ê²© ì •ì±… ë¡œì§)
// ==========================================
app.get('/', async (req, res) => {
    const rainPop = await getWeatherForecast();
    
    // í‹°íƒ€ì„: ë‚´ì¼ ì•„ì¹¨ 8ì‹œ
    const teeOffTime = new Date();
    teeOffTime.setDate(teeOffTime.getDate() + 1);
    teeOffTime.setHours(8, 0, 0, 0);
    const now = new Date();
    const hoursLeft = Math.floor((teeOffTime - now) / (1000 * 60 * 60));

    let currentPrice = BASE_PRICE;
    let reasons = [];

    // (1) ë‚ ì”¨ í• ì¸
    if (rainPop >= 60) {
        let dc = BASE_PRICE * 0.2; currentPrice -= dc;
        reasons.push(`â˜”ï¸ ë¹„ ì˜ˆë³´(${rainPop}%) 20% í• ì¸`);
    } else if (rainPop >= 30) {
        let dc = BASE_PRICE * 0.1; currentPrice -= dc;
        reasons.push(`â˜ï¸ íë¦¼(${rainPop}%) 10% í• ì¸`);
    }
    
    // (2) ì„ë°•í‹° í• ì¸
    if (hoursLeft < 24) {
        let dc = BASE_PRICE * 0.15; currentPrice -= dc;
        reasons.push(`â° ì„ë°• í‹°(${hoursLeft}ì‹œê°„ ì „) 15% í• ì¸`);
    }

    // (3) [NEW] ìœ„ì¹˜ ê¸°ë°˜ í• ì¸ (LBS)
    // ì‚¬ìš©ìì™€ ê³¨í”„ì¥ì˜ ì¢Œí‘œê°€ ê°™ê±°ë‚˜ ì•„ì£¼ ê°€ê¹Œìš°ë©´ í• ì¸
    if (userProfile.currentLocation.x === GRID_X && userProfile.currentLocation.y === GRID_Y) {
        let dc = BASE_PRICE * 0.1; // 10% ì¶”ê°€ í• ì¸
        currentPrice -= dc;
        reasons.push(`ğŸ“ í˜„ì¬ ê³¨í”„ì¥ ê·¼ì²˜ì— ê³„ì‹œë„¤ìš”! (ë™ë„¤ ì´ì›ƒ 10% í• ì¸)`);
    }

    // (4) [NEW] ì¶©ì„± ê³ ê° í• ì¸ (CRM)
    // ì ‘ì† 10íšŒ ì´ìƒ AND ì²´ë¥˜ì‹œê°„ 30ë¶„ ì´ìƒ
    if (userProfile.visitCount >= 10 && userProfile.avgStayTime >= 30) {
        let dc = 10000; // ì •ì•¡ í• ì¸ (ë§Œì›)
        currentPrice -= dc;
        reasons.push(`â¤ï¸ ì¶©ì„± ê³ ê° ê°ì‚¬ ì¿ í° (10,000ì› ì¦‰ì‹œ í• ì¸)`);
    }

    // HTML ë””ìì¸
    const html = `
        <html>
        <head>
            <title>${CLUB_NAME} Smart Booking</title>
            <style>
                body { font-family: 'Helvetica Neue', sans-serif; background-color: #121212; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; color: white; }
                .card { background: linear-gradient(145deg, #1e1e1e, #2a2a2a); padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: 380px; text-align: center; border: 1px solid #333; position: relative; overflow: hidden; }
                .badge-container { display: flex; justify-content: center; gap: 5px; margin-bottom: 15px; }
                .badge { font-size: 10px; padding: 4px 8px; border-radius: 4px; font-weight: bold; }
                .badge-vip { background: #d4af37; color: black; }
                .badge-loc { background: #3498db; color: white; }
                h1 { margin: 10px 0; font-size: 26px; letter-spacing: -1px; }
                .price-tag { display: flex; justify-content: center; align-items: baseline; gap: 5px; margin: 20px 0; }
                .original-price { font-size: 18px; color: #666; text-decoration: line-through; }
                .final-price { font-size: 42px; color: #2ecc71; font-weight: bold; }
                .info-box { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px; text-align: left; margin-bottom: 20px; font-size: 13px; color: #bbb; }
                .discount-list { list-style: none; padding: 0; text-align: left; margin: 0; }
                .discount-list li { background: rgba(46, 204, 113, 0.1); color: #2ecc71; padding: 8px 12px; border-radius: 6px; margin-bottom: 6px; font-size: 13px; font-weight: bold; display: flex; align-items: center; }
                .btn { background: #2ecc71; color: #000; padding: 16px; width: 100%; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
                .btn:hover { background: #27ae60; }
            </style>
        </head>
        <body>
            <div class="card">
                <div class="badge-container">
                    <span class="badge badge-vip">ğŸ‘‘ LOYALTY</span>
                    <span class="badge badge-loc">ğŸ“ NEARBY</span>
                </div>
                <h1>${CLUB_NAME}</h1>
                <p style="color:#777; font-size:12px; margin-top:-5px;">AI Dynamic Pricing System</p>
                
                <div class="price-tag">
                    <span class="original-price">${BASE_PRICE.toLocaleString()}</span>
                    <span class="final-price">${currentPrice.toLocaleString()}</span>
                    <span style="font-size:20px; color:#2ecc71;">ì›</span>
                </div>
                
                <div class="info-box">
                    <div>ğŸ‘¤ <strong>ê³ ê°:</strong> ${userProfile.name} (ìµœê·¼ ${userProfile.visitCount}íšŒ ë°©ë¬¸)</div>
                    <div style="margin-top:5px;">ğŸ“ <strong>ìœ„ì¹˜:</strong> ì¸ì²œ (ê³¨í”„ì¥ ì¸ê·¼ ê°ì§€ë¨)</div>
                    <div style="margin-top:5px;">â³ <strong>ë‚¨ì€ ì‹œê°„:</strong> ${hoursLeft}ì‹œê°„</div>
                </div>

                <ul class="discount-list">
                    ${reasons.map(r => `<li>${r}</li>`).join('')}
                </ul>

                <button class="btn">ìµœì €ê°€ ì˜ˆì•½í•˜ê¸°</button>
            </div>
        </body>
        </html>
    `;

    res.send(html);
});

app.listen(port, () => {
    console.log(`ğŸš€ ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸ ì™„ë£Œ: http://localhost:${port}`);
});